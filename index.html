<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- METADATA PARA REDES SOCIALES (WhatsApp, Facebook) -->
    <meta property="og:title" content="Cotizador Mayorista - Precios Oficiales">
    <meta property="og:description" content="Consulta los precios reales del Mercado Mayorista (MIDAGRI) desde tu celular. 춰No pagues de m치s!">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Cotizador Express">
    <!-- Fin Metadata -->

    <title>Cotizador Mayorista - Precios al D칤a</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- GOOGLE ANALYTICS -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GH82KPENC4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GH82KPENC4');
    </script>

    <style>
        .touch-action-manipulation { touch-action: manipulation; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans antialiased min-h-screen pb-32">

    <!-- Encabezado M칩vil -->
    <header class="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-xl font-bold flex items-center">
                    <i class="fas fa-box-open mr-2"></i> Cotizador Express
                </h1>
                <p id="fechaReporte" class="text-xs text-blue-200">Cargando precios...</p>
            </div>
            <div class="text-right">
                <div id="statusBadge" class="text-xs font-bold bg-yellow-500 px-2 py-1 rounded text-white">
                    CARGANDO...
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-lg mx-auto p-4">

        <!-- AVISO LEGAL -->
        <div class="bg-orange-50 border-l-4 border-orange-400 p-3 mb-4 rounded-r shadow-sm flex items-start">
            <i class="fas fa-info-circle text-orange-500 mt-0.5 mr-2"></i>
            <p class="text-xs text-orange-800 leading-tight">
                <strong>Precios Referenciales:</strong> Basados en reporte oficial MIDAGRI (por mayor). El precio final puede variar seg칰n calidad y puesto.
            </p>
        </div>

        <!-- Buscador Principal -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6 sticky top-20 z-40 border border-slate-200">
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-2 block">Agregar Producto</label>
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                <input type="text" id="searchInput" 
                    placeholder="Buscar (ej: Lim칩n, Papa...)" 
                    inputmode="search"
                    enterkeyhint="search"
                    class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all text-lg"
                    autocomplete="off" 
                    autocorrect="off"
                    spellcheck="false"
                    disabled>
                
                <!-- Lista de Sugerencias -->
                <div id="suggestions" class="absolute w-full bg-white shadow-xl rounded-b-lg border border-t-0 border-slate-200 hidden max-h-60 overflow-y-auto z-50">
                </div>
            </div>
        </div>

        <!-- Lista de Cotizaci칩n -->
        <div id="quoteList" class="space-y-3 mb-24">
            <!-- Estado Vac칤o -->
            <div id="emptyState" class="text-center py-12 text-slate-400">
                <i class="fas fa-spinner fa-spin text-4xl mb-3 opacity-30" id="loadingIcon"></i>
                <p id="emptyMsg">Cargando base de datos...</p>
            </div>
        </div>

    </main>

    <!-- Barra Inferior de Total -->
    <div class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-4 z-50 safe-pb">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <p class="text-xs text-slate-500 font-bold uppercase">Total Estimado</p>
                <p id="totalPrice" class="text-2xl font-black text-blue-700">S/ 0.00</p>
            </div>
            <button onclick="shareQuote()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-200 flex items-center transition-transform active:scale-95">
                <i class="fab fa-whatsapp mr-2 text-xl"></i> Pedir
            </button>
        </div>
    </div>

    <script>
        // --- CONFIGURACI칍N ---
        const CSV_URL = 'data/precios_mercado.csv'; 
        
        let database = [];
        let cart = [];
        let preciosColumnIndex = -1; 

        // Referencias DOM
        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestions');
        const quoteList = document.getElementById('quoteList');
        const emptyState = document.getElementById('emptyState');
        const totalPriceEl = document.getElementById('totalPrice');
        const statusBadge = document.getElementById('statusBadge');
        const fechaReporte = document.getElementById('fechaReporte');
        const loadingIcon = document.getElementById('loadingIcon');
        const emptyMsg = document.getElementById('emptyMsg');

        // 1. Cargar datos al iniciar
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error("No se encontr칩 el archivo CSV");
                
                const csvText = await response.text();
                procesarCSV(csvText);
                
                statusBadge.innerText = "ACTUALIZADO";
                statusBadge.className = "text-xs font-bold bg-green-500 px-2 py-1 rounded text-white fade-in";
                searchInput.disabled = false;
                
                loadingIcon.className = "fas fa-basket-shopping text-4xl mb-3 opacity-30";
                loadingIcon.removeAttribute('id'); 
                emptyMsg.innerText = "Tu cotizaci칩n est치 vac칤a.";
                emptyMsg.innerHTML += '<br><span class="text-sm">Usa el buscador para agregar productos.</span>';

            } catch (error) {
                console.error(error);
                statusBadge.innerText = "ERROR";
                statusBadge.className = "text-xs font-bold bg-red-500 px-2 py-1 rounded text-white";
                fechaReporte.innerText = "Error de carga";
                emptyMsg.innerText = "No se pudo leer el archivo de precios.";
            }
        });

        // 2. Procesar CSV 
        function procesarCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) return;

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Usamos la pen칰ltima columna (la 칰ltima suele ser variaci칩n %)
            preciosColumnIndex = headers.length - 2; 
            const nombreHeader = headers[preciosColumnIndex];
            
            fechaReporte.innerText = `Precios del: ${nombreHeader}`;

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(','); 
                
                if (row.length < headers.length) continue;

                const nombre = row[1]; 
                const mercado = row[2]; 
                const precioStr = row[preciosColumnIndex];

                const precio = parseFloat(precioStr);

                if (nombre && !isNaN(precio)) {
                    database.push({
                        id: i,
                        name: nombre.replace(/"/g, ''),
                        market: mercado.replace(/"/g, ''),
                        price: precio
                    });
                }
            }
        }

        // 3. L칩gica de B칰squeda
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            suggestionsBox.innerHTML = '';
            
            if (query.length < 2) {
                suggestionsBox.classList.add('hidden');
                return;
            }

            const matches = database.filter(item => item.name.toLowerCase().includes(query)).slice(0, 10);
            
            if (matches.length > 0) {
                suggestionsBox.classList.remove('hidden');
                matches.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 flex justify-between items-center tap-highlight-transparent";
                    div.innerHTML = `
                        <div>
                            <span class="font-medium text-slate-700 block text-sm">${item.name}</span>
                            <span class="text-xs text-slate-400">${item.market}</span>
                        </div>
                        <span class="font-bold text-blue-600">S/ ${item.price.toFixed(2)}</span>
                    `;
                    div.onclick = () => addToCart(item);
                    suggestionsBox.appendChild(div);
                });
            } else {
                suggestionsBox.classList.add('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });

        function addToCart(item) {
            cart.push({...item}); 
            updateUI();
            searchInput.value = '';
            suggestionsBox.classList.add('hidden');
            // MEJORA MOBILE: Quitamos el foco para esconder el teclado
            searchInput.blur(); 
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateUI();
        }

        function updateUI() {
            quoteList.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                quoteList.appendChild(emptyState);
                emptyState.style.display = 'block';
                emptyMsg.innerHTML = 'Tu cotizaci칩n est치 vac칤a.<br><span class="text-sm">Usa el buscador para agregar productos.</span>';
                loadingIcon.className = "fas fa-basket-shopping text-4xl mb-3 opacity-30";
            } else {
                emptyState.style.display = 'none';
                cart.forEach((item, index) => {
                    total += item.price;
                    const el = document.createElement('div');
                    el.className = "bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center fade-in";
                    el.innerHTML = `
                        <div class="flex items-center flex-1">
                            <div class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs mr-3 flex-shrink-0">
                                ${index + 1}
                            </div>
                            <div class="pr-2">
                                <h3 class="font-bold text-slate-700 text-sm leading-tight">${item.name}</h3>
                                <p class="text-xs text-slate-400 mt-1">${item.market}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-bold text-slate-800 mr-3">S/ ${item.price.toFixed(2)}</span>
                            <button onclick="removeFromCart(${index})" class="text-red-400 p-2 hover:bg-red-50 rounded-full transition tap-highlight-transparent">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    quoteList.appendChild(el);
                });
            }
            
            totalPriceEl.innerText = `S/ ${total.toFixed(2)}`;
        }

        function shareQuote() {
            if (cart.length === 0) return alert("Agrega productos primero");
            
            let text = "*COTIZACI칍N DEL D칈A* 游뇦n";
            text += `游늰 Ref: ${fechaReporte.innerText.replace('Precios del: ', '')}\n\n`;
            
            let total = 0;
            cart.forEach(item => {
                text += `郊쀮잺 ${item.name}: S/ ${item.price.toFixed(2)}\n`;
                total += item.price;
            });
            text += `\n*TOTAL APROX: S/ ${total.toFixed(2)}*`;
            text += `\n\n游댌 Consulta m치s precios aqu칤: ${window.location.href}`;
            
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }
    </script>
</body>
</html>

