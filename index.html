<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor de Precios - MIDAGRI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        .touch-action-manipulation { touch-action: manipulation; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .bg-pattern { background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 0.5px, transparent 0.5px); background-size: 15px 15px; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        body.modal-open { overflow: hidden; height: 100vh; }
        .col-val { min-width: 70px; text-align: right; white-space: nowrap; }
        .animate-full-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-pattern text-slate-800 font-sans antialiased min-h-screen pb-40">

    <header class="bg-blue-700 text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-xl font-black flex items-center tracking-tighter uppercase italic">
                    <i class="fas fa-chart-line mr-2 not-italic"></i> Monitor
                </h1>
                <p id="fechaReporte" class="text-[10px] text-blue-200 uppercase font-black tracking-widest mt-0.5">Cargando...</p>
            </div>
            <button onclick="installAppPrompt()" class="bg-blue-600 hover:bg-blue-500 text-[9px] font-black px-3 py-2 rounded-lg border border-white/20 flex items-center active:scale-95 transition-all">
                <i class="fas fa-mobile-alt mr-1.5"></i> INSTALAR APP
            </button>
        </div>
    </header>

    <main class="max-w-lg mx-auto p-4">

        <!-- Banner Oficial -->
        <div class="bg-white border-b-4 border-blue-600 p-4 mb-6 rounded-xl shadow-md fade-in">
            <div class="flex items-start">
                <div class="bg-blue-100 p-2 rounded-lg mr-3">
                    <i class="fas fa-info-circle text-blue-600"></i>
                </div>
                <p class="text-[11px] text-slate-600 leading-relaxed font-medium">
                    <strong class="text-blue-700 block mb-0.5 uppercase tracking-tighter text-xs">Informaci√≥n Oficial:</strong>
                    Precios Referenciales: Basados en reporte oficial MIDAGRI (Kg por mayor). El precio final puede variar seg√∫n calidad y puesto.
                </p>
            </div>
        </div>

        <!-- Botones de An√°lisis -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="openPriceModal()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center text-center active:bg-slate-50">
                <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center mb-2">
                    <i class="fas fa-tags text-indigo-500"></i>
                </div>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Precios</span>
                <span class="text-[11px] font-bold text-slate-700 leading-none">Los + Caros y Baratos</span>
            </button>
            <button onclick="openVarModal()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center text-center active:bg-slate-50">
                <div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center mb-2">
                    <i class="fas fa-percentage text-emerald-500"></i>
                </div>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Variaci√≥n</span>
                <span class="text-[11px] font-bold text-slate-700 leading-none">Los que + Cambiaron</span>
            </button>
        </div>

        <!-- Buscador -->
        <div class="bg-white rounded-2xl shadow-xl p-5 mb-6 border border-slate-200 relative">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block italic">¬øQu√© vas a comprar hoy?</label>
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-4 text-slate-300"></i>
                <input type="text" id="searchInput" 
                    placeholder="Busca papas, lim√≥n, cebolla..." 
                    inputmode="search"
                    class="w-full pl-11 pr-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:bg-white outline-none transition-all text-lg font-bold">
                
                <div id="suggestions" class="absolute w-full bg-white shadow-2xl rounded-xl border border-slate-200 hidden max-h-[350px] overflow-y-auto z-50 mt-2"></div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-4">
                <button onclick="quickSearch('Papa')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">ü•î Papas</button>
                <button onclick="quickSearch('Limon')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">üçã Lim√≥n</button>
                <button onclick="quickSearch('Cebolla')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">üßÖ Cebolla</button>
                <button onclick="quickSearch('Tomate')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">üçÖ Tomate</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 px-1">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Mi Lista de Ahorro</h2>
            <button onclick="clearCart()" class="text-[10px] font-black text-red-400 uppercase tracking-tighter bg-red-50 px-3 py-1 rounded-full">Vaciar</button>
        </div>

        <div id="quoteList" class="space-y-3 mb-32">
            <div id="emptyState" class="bg-white/40 border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center text-slate-400 font-bold text-xs uppercase tracking-widest leading-relaxed">
                Tu lista est√° vac√≠a.<br>Agrega productos para calcular.
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-slate-200 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] p-5 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Suma Total</p>
                <p id="totalPrice" class="text-3xl font-black text-blue-900 tracking-tighter">S/ 0.00</p>
            </div>
            <button onclick="shareQuote()" class="bg-green-500 text-white px-8 py-4 rounded-2xl font-black shadow-lg flex items-center active:scale-95 transition-all">
                <i class="fab fa-whatsapp mr-2 text-xl"></i> PEDIR
            </button>
        </div>
    </div>

    <!-- MODAL PRECIOS -->
    <div id="priceModal" class="fixed inset-0 bg-white z-[100] hidden flex-col animate-full-up">
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center">
            <h3 class="text-sm font-black uppercase italic tracking-widest">Extremos del D√≠a</h3>
            <button onclick="closeModals()" class="bg-white/10 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
        </header>
        <div class="flex-1 overflow-y-auto p-4 space-y-8">
            <div>
                <h4 class="text-[10px] font-black text-red-500 uppercase tracking-widest mb-3 flex items-center"><i class="fas fa-arrow-circle-up mr-2"></i> Top 5: Los m√°s caros</h4>
                <div id="topExpensive" class="bg-slate-50 rounded-2xl overflow-hidden border border-slate-100"></div>
            </div>
            <div>
                <h4 class="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-3 flex items-center"><i class="fas fa-arrow-circle-down mr-2"></i> Top 5: Los m√°s econ√≥micos</h4>
                <div id="topCheap" class="bg-slate-50 rounded-2xl overflow-hidden border border-slate-100"></div>
            </div>
        </div>
        <button onclick="closeModals()" class="m-4 p-4 bg-slate-900 text-white font-black rounded-2xl uppercase tracking-widest text-xs">Cerrar y volver</button>
    </div>

    <!-- MODAL VARIACION -->
    <div id="varModal" class="fixed inset-0 bg-white z-[100] hidden flex-col animate-full-up">
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center">
            <h3 class="text-sm font-black uppercase italic tracking-widest">Variaciones (%)</h3>
            <button onclick="closeModals()" class="bg-white/10 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
        </header>
        <div class="flex-1 overflow-y-auto p-4 space-y-8">
            <div>
                <h4 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-3 flex items-center"><i class="fas fa-chart-line mr-2"></i> Top 5: Los que m√°s subieron</h4>
                <div id="topUp" class="bg-slate-50 rounded-2xl overflow-hidden border border-slate-100"></div>
            </div>
            <div>
                <h4 class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-3 flex items-center"><i class="fas fa-chart-line fa-flip-vertical mr-2"></i> Top 5: Los que m√°s bajaron</h4>
                <div id="topDown" class="bg-slate-50 rounded-2xl overflow-hidden border border-slate-100"></div>
            </div>
        </div>
        <button onclick="closeModals()" class="m-4 p-4 bg-slate-900 text-white font-black rounded-2xl uppercase tracking-widest text-xs">Cerrar y volver</button>
    </div>

    <script>
        const CSV_URL = 'data/precios_mercado.csv'; 
        let database = [];
        let cart = [];
        let colHoy = -1, colAyer = -1, colVar = -1;

        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestions');
        const quoteList = document.getElementById('quoteList');
        const totalPriceEl = document.getElementById('totalPrice');
        const fechaReporte = document.getElementById('fechaReporte');

        // Funci√≥n para quitar acentos
        const normalizeStr = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                procesarCSV(csvText);
                searchInput.disabled = false;
            } catch (e) {
                console.error("Error cargando CSV");
            }
        });

        function procesarCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            colHoy = headers.length - 2;
            colAyer = headers.length - 3;
            colVar = headers.length - 1;
            fechaReporte.innerText = `Referencia: ${headers[colHoy]}`;

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < headers.length) continue;
                const pHoy = parseFloat(row[colHoy]);
                const pAyer = parseFloat(row[colAyer]);
                const vStr = row[colVar] ? row[colVar].replace(/"/g, '') : "0.0%";
                const vFloat = parseFloat(vStr.replace('%','')) || 0;
                if (!isNaN(pHoy) && row[1]) {
                    database.push({
                        name: row[1].replace(/"/g, '').trim(),
                        market: row[2].replace(/"/g, '').trim(),
                        priceToday: pHoy,
                        priceYesterday: pAyer,
                        varStr: vStr,
                        varFloat: vFloat,
                        nameNormalized: normalizeStr(row[1])
                    });
                }
            }
        }

        function renderTable(containerId, list, isPrice) {
            const container = document.getElementById(containerId);
            const isTopExpensive = containerId === 'topExpensive';
            const isTopCheap = containerId === 'topCheap';

            let html = `<table class="w-full text-[10px] table-fixed">
                <thead class="bg-slate-200 text-slate-500 font-black uppercase">
                    <tr>
                        <th class="p-3 text-left">Producto</th>
                        <th class="p-3 text-right w-16">${isPrice ? 'Ayer' : 'Mercado'}</th>
                        <th class="p-3 text-right w-20">${isPrice ? 'Hoy' : 'Var %'}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">`;
            
            list.forEach(item => {
                const isDown = item.varFloat < 0;
                let vColor = isDown ? 'text-emerald-500' : (item.varFloat > 0 ? 'text-red-500' : 'text-slate-400');
                
                // Color espec√≠fico para la tabla de Precios
                let finalPriceColor = 'text-blue-700';
                if (isPrice) {
                    if (isTopExpensive) finalPriceColor = 'text-red-600';
                    if (isTopCheap) finalPriceColor = 'text-emerald-600';
                } else {
                    finalPriceColor = vColor;
                }

                html += `<tr class="bg-white">
                    <td class="p-3 font-bold text-slate-700 truncate">${item.name}</td>
                    <td class="p-3 text-right text-slate-400 whitespace-nowrap">${isPrice ? 'S/' + (item.priceYesterday || 0).toFixed(2) : item.market}</td>
                    <td class="p-3 text-right font-black col-val ${finalPriceColor}">
                        ${isPrice ? 'S/' + item.priceToday.toFixed(2) : item.varStr}
                    </td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function openPriceModal() {
            document.body.classList.add('modal-open');
            document.getElementById('priceModal').style.display = 'flex';
            const sorted = [...database].sort((a,b) => b.priceToday - a.priceToday);
            renderTable('topExpensive', sorted.slice(0, 5), true);
            renderTable('topCheap', sorted.slice(-5).reverse(), true);
        }

        function openVarModal() {
            document.body.classList.add('modal-open');
            document.getElementById('varModal').style.display = 'flex';
            const sorted = [...database].sort((a,b) => b.varFloat - a.varFloat);
            renderTable('topUp', sorted.slice(0, 5), false);
            renderTable('topDown', sorted.slice(-5).reverse(), false);
        }

        function closeModals() {
            document.body.classList.remove('modal-open');
            document.getElementById('priceModal').style.display = 'none';
            document.getElementById('varModal').style.display = 'none';
            setTimeout(() => searchInput.focus(), 100);
        }

        function quickSearch(val) {
            searchInput.value = val;
            const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
            searchInput.focus();
        }

        searchInput.addEventListener('input', (e) => {
            const query = normalizeStr(e.target.value);
            suggestionsBox.innerHTML = '';
            if (query.length < 2) { suggestionsBox.classList.add('hidden'); return; }
            
            const matches = database.filter(item => item.nameNormalized.includes(query)).slice(0, 10);
            
            if (matches.length > 0) {
                suggestionsBox.classList.remove('hidden');
                matches.forEach(item => {
                    const isDown = item.varFloat < 0;
                    const vColor = isDown ? 'text-emerald-500' : (item.varFloat > 0 ? 'text-red-500' : 'text-slate-400');
                    const vIcon = isDown ? 'fa-arrow-down' : (item.varFloat === 0 ? 'fa-minus' : 'fa-arrow-up');
                    const div = document.createElement('div');
                    div.className = "p-4 hover:bg-blue-50 border-b border-slate-100 flex justify-between items-center active:bg-blue-100";
                    div.innerHTML = `
                        <div class="flex-1 min-w-0 pr-2">
                            <span class="font-bold text-slate-700 block text-sm truncate">${item.name}</span>
                            <span class="text-[9px] text-slate-400 font-black uppercase tracking-tighter">${item.market}</span>
                        </div>
                        <div class="text-right shrink-0">
                            <div class="font-black text-blue-700">S/ ${item.priceToday.toFixed(2)}</div>
                            <div class="text-[9px] font-black ${vColor}"><i class="fas ${vIcon} mr-0.5"></i> ${item.varStr}</div>
                        </div>
                    `;
                    div.onclick = () => addToCart(item);
                    suggestionsBox.appendChild(div);
                });
            } else { suggestionsBox.classList.add('hidden'); }
        });

        function addToCart(item) {
            cart.push({...item});
            updateUI();
            searchInput.value = '';
            suggestionsBox.classList.add('hidden');
            searchInput.blur();
        }

        function clearCart() { if(confirm("¬øVaciar lista?")) { cart = []; updateUI(); } }

        function updateUI() {
            quoteList.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                quoteList.innerHTML = `<div class="bg-white/40 border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center text-slate-400 font-bold text-xs uppercase tracking-widest leading-relaxed">Tu lista est√° vac√≠a.<br>Agrega productos para calcular.</div>`;
            } else {
                cart.forEach((item, index) => {
                    total += item.priceToday;
                    const isDown = item.varFloat < 0;
                    const vColor = isDown ? 'text-emerald-500' : (item.varFloat > 0 ? 'text-red-500' : 'text-slate-400');
                    const vIcon = isDown ? 'fa-arrow-down' : (item.varFloat === 0 ? 'fa-minus' : 'fa-arrow-up');
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center fade-in";
                    el.innerHTML = `
                        <div class="flex items-center flex-1 min-w-0 pr-2">
                            <div class="w-7 h-7 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center font-black text-[10px] mr-3 shrink-0">
                                ${index + 1}
                            </div>
                            <div class="min-w-0">
                                <h3 class="font-bold text-slate-700 text-sm truncate leading-none mb-1">${item.name}</h3>
                                <div class="flex items-center text-[9px] font-black uppercase tracking-tighter">
                                    <span class="text-slate-400 mr-2">${item.market}</span>
                                    <span class="${vColor} flex items-center whitespace-nowrap"><i class="fas ${vIcon} mr-0.5"></i>${item.varStr}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center shrink-0">
                            <span class="font-black text-slate-800 mr-3 text-sm">S/ ${item.priceToday.toFixed(2)}</span>
                            <button onclick="removeFromCart(${index})" class="text-slate-300 hover:text-red-500 transition-colors">
                                <i class="fas fa-times-circle text-xl"></i>
                            </button>
                        </div>
                    `;
                    quoteList.appendChild(el);
                });
            }
            totalPriceEl.innerText = `S/ ${total.toFixed(2)}`;
        }

        function removeFromCart(index) { cart.splice(index, 1); updateUI(); }

        function shareQuote() {
            if (cart.length === 0) return alert("¬°Lista vac√≠a!");
            let text = "*MI LISTA DE AHORRO* üõí\n";
            text += `üìÖ _${fechaReporte.innerText}_\n\n`;
            let total = 0;
            cart.forEach(item => {
                const trend = item.varFloat < 0 ? 'üìâ' : (item.varFloat > 0 ? 'üìà' : '‚ûñ');
                text += `‚Ä¢ *${item.name}*: S/ ${item.priceToday.toFixed(2)} ${trend} _(${item.varStr})_\n`;
                total += item.priceToday;
            });
            text += `\n*TOTAL ESTIMADO: S/ ${total.toFixed(2)}*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function installAppPrompt() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                alert("Instala esta App: Toca el bot√≥n 'Compartir' (el cuadrado con flecha) y selecciona 'Agregar al inicio'.");
            } else {
                alert("Instala esta App: Toca los 3 puntos de Chrome y selecciona 'Instalar aplicaci√≥n' o 'Agregar a la pantalla de inicio'.");
            }
        }

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
