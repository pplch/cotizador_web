<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#1d4ed8">
    
    <title>Monitor de Precios - MIDAGRI</title>
    
    <!-- PWA: Manifest para instalaci√≥n -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Estilos externos -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- PWA: Registro del Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js');
        });
      }
    </script>
    
    <style>
        .touch-action-manipulation { touch-action: manipulation; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .bg-pattern { background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 0.5px, transparent 0.5px); background-size: 15px 15px; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        body.modal-open { overflow: hidden; height: 100vh; }
        .col-val { min-width: 70px; text-align: right; white-space: nowrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        .animate-full-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Mejoras para tablas responsive */
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .price-table { min-width: 280px; }
        .price-number { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; letter-spacing: 0.5px; }

        /* Animaci√≥n para notificaciones */
        .animate-fade-in {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Clase para fila seleccionada (tap largo) */
        .bg-green-100 {
            background-color: #d1fae5 !important;
            transition: background-color 0.2s;
        }
        
    </style>
</head>
<body class="bg-pattern text-slate-800 font-sans antialiased min-h-screen pb-40">

    <header class="bg-blue-700 text-white p-4 shadow-xl sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-xl font-black flex items-center tracking-tighter uppercase italic">
                    <i class="fas fa-chart-line mr-2 not-italic"></i> Monitor
                </h1>
                <p id="fechaReporte" class="text-[10px] text-blue-200 uppercase font-black tracking-widest mt-0.5">Cargando...</p>
            </div>
            <button onclick="installAppPrompt()" class="bg-blue-600 hover:bg-blue-500 text-[9px] font-black px-3 py-2 rounded-lg border border-white/20 flex items-center active:scale-95 transition-all">
                <i class="fas fa-mobile-alt mr-1.5"></i> INSTALAR APP
            </button>
        </div>
    </header>

    <main class="max-w-lg mx-auto p-4">

        <!-- Banner Oficial -->
        <div class="bg-white border-b-4 border-blue-600 p-4 mb-6 rounded-xl shadow-md fade-in">
            <div class="flex items-start">
                <div class="bg-blue-100 p-2 rounded-lg mr-3">
                    <i class="fas fa-info-circle text-blue-600"></i>
                </div>
                <p class="text-[11px] text-slate-600 leading-relaxed font-medium">
                    <strong class="text-blue-700 block mb-0.5 uppercase tracking-tighter text-xs">Informaci√≥n Oficial:</strong>
                    Precios Referenciales: Basados en reporte oficial MIDAGRI (Kg por mayor). El precio final puede variar seg√∫n calidad y puesto.
                </p>
            </div>
        </div>

        <!-- Botones de An√°lisis -->
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="openPriceModal()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center text-center active:bg-slate-50">
                <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center mb-2">
                    <i class="fas fa-tags text-indigo-500"></i>
                </div>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Precios</span>
                <span class="text-[11px] font-bold text-slate-700 leading-none">Los + Caros y Baratos</span>
            </button>
            <button onclick="openVarModal()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col items-center text-center active:bg-slate-50">
                <div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center mb-2">
                    <i class="fas fa-percentage text-emerald-500"></i>
                </div>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">Variaci√≥n</span>
                <span class="text-[11px] font-bold text-slate-700 leading-none">Los que + Cambiaron</span>
            </button>
        </div>

        <!-- Buscador -->
        <div class="bg-white rounded-2xl shadow-xl p-5 mb-6 border border-slate-200 relative">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block italic">¬øQu√© vas a comprar hoy?</label>
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-4 text-slate-300"></i>
                <input type="text" id="searchInput" 
                    placeholder="Busca papas, lim√≥n, cebolla..." 
                    inputmode="search"
                    class="w-full pl-11 pr-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:bg-white outline-none transition-all text-lg font-bold">
                
                <div id="suggestions" class="absolute w-full bg-white shadow-2xl rounded-xl border border-slate-200 hidden max-h-[350px] overflow-y-auto z-50 mt-2"></div>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-4">
                <button onclick="quickSearch('Papa')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">ü•î Papas</button>
                <button onclick="quickSearch('Limon')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">üçã Lim√≥n</button>
                <button onclick="quickSearch('Cebolla')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">üßÖ Cebolla</button>
                <button onclick="quickSearch('Tomate')" class="px-3 py-1.5 bg-slate-100 text-slate-500 rounded-lg text-[10px] font-black uppercase tracking-tighter">üçÖ Tomate</button>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4 px-1">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Mi Lista de Ahorro</h2>
            <button onclick="clearCart()" class="text-[10px] font-black text-red-400 uppercase tracking-tighter bg-red-50 px-3 py-1 rounded-full">Vaciar</button>
        </div>

        <div id="quoteList" class="space-y-3 mb-32">
            <div id="emptyState" class="bg-white/40 border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center text-slate-400 font-bold text-xs uppercase tracking-widest leading-relaxed">
                Tu lista est√° vac√≠a.<br>Agrega productos para calcular.
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-md border-t border-slate-200 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] p-5 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Suma Total</p>
                <p id="totalPrice" class="text-3xl font-black text-blue-900 tracking-tighter price-number">S/ 0.00</p>
            </div>
            <button onclick="shareQuote()" class="bg-green-500 text-white px-8 py-4 rounded-2xl font-black shadow-lg flex items-center active:scale-95 transition-all">
                <i class="fab fa-whatsapp mr-2 text-xl"></i> PEDIR
            </button>
        </div>
    </div>


    <!-- MODAL PRECIOS (VERSI√ìN UNIFICADA) -->
    <div id="priceModal" class="fixed inset-0 bg-white z-[100] hidden flex-col animate-full-up">
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center">
            <h3 class="text-sm font-black uppercase italic tracking-widest">Ranking de Precios</h3>
            <button onclick="closeModals()" class="bg-white/10 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
        </header>
    
        <!-- BOTONES DE ORDEN - NUEVO -->
        <div class="flex border-b border-slate-200">
            <button id="btnDesc" onclick="setPriceOrder('desc')" class="flex-1 py-3 text-center text-sm font-bold bg-blue-50 text-blue-700 border-r border-slate-200">
                <i class="fas fa-arrow-down mr-2"></i>De m√°s caros a econ√≥micos
            </button>
            <button id="btnAsc" onclick="setPriceOrder('asc')" class="flex-1 py-3 text-center text-sm font-bold text-slate-600">
                <i class="fas fa-arrow-up mr-2"></i>De m√°s econ√≥micos a caros
            </button>
    </div>
    
    <!-- TABLA √öNICA - NUEVO -->
    <div class="flex-1 overflow-y-auto p-4">
        <div class="table-container bg-slate-50 rounded-2xl border border-slate-100 overflow-hidden">
            <div id="priceRankingTable" class="price-table min-w-full"></div>
        </div>
    </div>
    
    <button onclick="closeModals()" class="m-4 p-4 bg-slate-900 text-white font-black rounded-2xl uppercase tracking-widest text-xs">Cerrar y volver</button>
</div>

    
    <!-- MODAL VARIACI√ìN (VERSI√ìN UNIFICADA) -->
    <div id="varModal" class="fixed inset-0 bg-white z-[100] hidden flex-col animate-full-up">
        <header class="bg-slate-900 text-white p-4 flex justify-between items-center">
            <h3 class="text-sm font-black uppercase italic tracking-widest">Variaciones %</h3>
            <button onclick="closeModals()" class="bg-white/10 w-10 h-10 rounded-full flex items-center justify-center"><i class="fas fa-times"></i></button>
        </header>
    
        <!-- BOTONES DE ORDEN - NUEVO -->
        <div class="flex border-b border-slate-200">
            <button id="btnVarDesc" onclick="setVarOrder('desc')" class="flex-1 py-3 text-center text-sm font-bold bg-orange-50 text-orange-700 border-r border-slate-200">
                <i class="fas fa-chart-line mr-2"></i>Los que m√°s subieron
            </button>
            <button id="btnVarAsc" onclick="setVarOrder('asc')" class="flex-1 py-3 text-center text-sm font-bold text-slate-600">
                <i class="fas fa-chart-line fa-flip-vertical mr-2"></i>Los que m√°s bajaron
            </button>
    </div>
    
    <!-- TABLA √öNICA - NUEVO -->
    <div class="flex-1 overflow-y-auto p-4">
        <div class="table-container bg-slate-50 rounded-2xl border border-slate-100 overflow-hidden">
            <div id="varRankingTable" class="price-table min-w-full"></div>
        </div>
    </div>
    
    <button onclick="closeModals()" class="m-4 p-4 bg-slate-900 text-white font-black rounded-2xl uppercase tracking-widest text-xs">Cerrar y volver</button>
</div>

    <script>
        const CSV_URL = 'data/precios_mercado.csv'; 
        let database = [];
        let cart = [];
        let colHoy = -1, colAyer = -1, colVar = -1;
        // NUEVA VARIABLE PARA CONTROLAR ORDEN DE PRECIOS
        let currentPriceOrder = 'desc'; // 'desc' = m√°s caros primero, 'asc' = m√°s baratos primero
        // NUEVA VARIABLE PARA CONTROLAR ORDEN DE VARIACI√ìN
        let currentVarOrder = 'desc'; // 'desc' = m√°s subieron primero, 'asc' = m√°s bajaron primero

        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestions');
        const quoteList = document.getElementById('quoteList');
        const totalPriceEl = document.getElementById('totalPrice');
        const fechaReporte = document.getElementById('fechaReporte');

        // Funci√≥n para quitar acentos
        const normalizeStr = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                procesarCSV(csvText);
                cargarCarritoGuardado();
                searchInput.disabled = false;
            } catch (e) {
                console.error("Error cargando CSV");
                cargarCarritoGuardado();
            }
        });

        function procesarCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            colHoy = headers.length - 2;
            colAyer = headers.length - 3;
            colVar = headers.length - 1;
            fechaReporte.innerText = `Referencia: ${headers[colHoy]}`;

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < headers.length) continue;
                const pHoy = parseFloat(row[colHoy]);
                const pAyer = parseFloat(row[colAyer]);
                const vStr = row[colVar] ? row[colVar].replace(/"/g, '') : "0.0%";
                const vFloat = parseFloat(vStr.replace('%','')) || 0;
                if (!isNaN(pHoy) && row[1]) {
                    database.push({
                        name: row[1].replace(/"/g, '').trim(),
                        market: row[2].replace(/"/g, '').trim(),
                        priceToday: pHoy,
                        priceYesterday: pAyer,
                        varStr: vStr,
                        varFloat: vFloat,
                        nameNormalized: normalizeStr(row[1])
                    });
                }
            }
        }

        // FUNCI√ìN MODIFICADA: Renderizar tabla de ranking (REEMPLAZA LA VIEJA renderTable)
        function renderRankingTable(list) {
            const container = document.getElementById('priceRankingTable');
    
            let html = `<table class="w-full text-[11px] table-auto">
                <thead class="bg-slate-200 text-slate-500 font-black uppercase">
                    <tr>
                        <th class="p-3 text-left w-16">#</th>
                        <th class="p-3 text-left">Producto</th>
                        <th class="p-3 text-right w-32">Ayer</th>
                        <th class="p-3 text-right w-24">Hoy</th>
                        <th class="p-3 text-right w-28">Var %</th>
                    </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">`;
    
   list.forEach(item => {
    const isDown = item.varFloat < 0;
    const vColor = isDown ? 'text-emerald-600' : (item.varFloat > 0 ? 'text-red-600' : 'text-slate-500');
    const vIcon = isDown ? 'fa-arrow-down' : (item.varFloat === 0 ? 'fa-minus' : 'fa-arrow-up');
    
    html += `<tr class="bg-white hover:bg-slate-50 cursor-pointer"
                ondblclick="agregarDesdeModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                
        <td class="p-3 text-center font-black text-slate-400">${item.position}</td>
        <td class="p-3 font-bold text-slate-800 truncate">
            ${item.name}
            <div class="text-[10px] text-slate-500 font-semibold uppercase tracking-tighter mt-0.5">${item.market}</div>
        </td>
        <td class="p-3 text-right price-number text-slate-500 font-medium">S/${(item.priceYesterday || 0).toFixed(2)}</td>
        <td class="p-3 text-right font-bold text-blue-800 price-number">S/${item.priceToday.toFixed(2)}</td>
        <td class="p-3 text-right font-bold ${vColor} price-number">
            <i class="fas ${vIcon} mr-1"></i>${item.varStr}
        </td>
    </tr>`;
});
    
    html += `</tbody></table>`;
    container.innerHTML = html;
}
        function openPriceModal() {
            document.body.classList.add('modal-open');
            document.getElementById('priceModal').style.display = 'flex';
    
            // Bot√≥n "desc" activo por defecto (m√°s caros primero)
            document.getElementById('btnDesc').classList.add('bg-blue-50', 'text-blue-700');
            document.getElementById('btnDesc').classList.remove('text-slate-600');
            document.getElementById('btnAsc').classList.remove('bg-blue-50', 'text-blue-700');
            document.getElementById('btnAsc').classList.add('text-slate-600');
    
            // Mostrar ranking inicial (orden descendente: m√°s caros primero)
            updatePriceRanking('desc');
        }
        
        // NUEVA FUNCI√ìN: Cambiar orden del ranking
        function setPriceOrder(order) {
            currentPriceOrder = order;
            updatePriceRanking(order);
    
            // Actualizar botones visualmente
            if (order === 'desc') {
                document.getElementById('btnDesc').classList.add('bg-blue-50', 'text-blue-700');
                document.getElementById('btnDesc').classList.remove('text-slate-600');
                document.getElementById('btnAsc').classList.remove('bg-blue-50', 'text-blue-700');
                document.getElementById('btnAsc').classList.add('text-slate-600');
            } else {
                document.getElementById('btnAsc').classList.add('bg-blue-50', 'text-blue-700');
                document.getElementById('btnAsc').classList.remove('text-slate-600');
                document.getElementById('btnDesc').classList.remove('bg-blue-50', 'text-blue-700');
                document.getElementById('btnDesc').classList.add('text-slate-600');
            }
    }

        // NUEVA FUNCI√ìN: Cambiar orden del ranking de variaci√≥n
        function setVarOrder(order) {
            currentVarOrder = order;
            updateVarRanking(order);
    
            // Actualizar botones visualmente
            if (order === 'desc') {
                document.getElementById('btnVarDesc').classList.add('bg-orange-50', 'text-orange-700');
                document.getElementById('btnVarDesc').classList.remove('text-slate-600');
                document.getElementById('btnVarAsc').classList.remove('bg-orange-50', 'text-orange-700');
                document.getElementById('btnVarAsc').classList.add('text-slate-600');
            } else {
                document.getElementById('btnVarAsc').classList.add('bg-orange-50', 'text-orange-700');
                document.getElementById('btnVarAsc').classList.remove('text-slate-600');
                document.getElementById('btnVarDesc').classList.remove('bg-orange-50', 'text-orange-700');
                document.getElementById('btnVarDesc').classList.add('text-slate-600');
            }
    }
        
        // NUEVA FUNCI√ìN: Actualizar tabla de ranking
        function updatePriceRanking(order) {
            // 1. Filtrar productos v√°lidos (precio > 0, no categor√≠as)
            const validProducts = database.filter(item => 
                item.priceToday > 0 && 
                !item.name.match(/^\d{2,4}\s+[A-Z]/) &&
                item.market !== ''
        );
    
        // 2. Ordenar seg√∫n el orden solicitado
        let sorted;
        if (order === 'desc') {
            // M√°s caros primero
            sorted = [...validProducts].sort((a, b) => b.priceToday - a.priceToday);
        } else {
            // M√°s baratos primero
            sorted = [...validProducts].sort((a, b) => a.priceToday - b.priceToday);
        }
    
        // 3. Agregar posici√≥n (ranking)
        const rankedProducts = sorted.map((item, index) => ({
            ...item,
            position: index + 1
        }));
    
        // 4. Renderizar tabla √∫nica
        renderRankingTable(rankedProducts);
    }

        // NUEVA FUNCI√ìN: Renderizar tabla de ranking de variaci√≥n
        function renderVarRankingTable(list) {
            const container = document.getElementById('varRankingTable');
    
            let html = `<table class="w-full text-[11px] table-auto">
                <thead class="bg-slate-200 text-slate-500 font-black uppercase">
                    <tr>
                        <th class="p-3 text-left w-16">#</th>
                        <th class="p-3 text-left">Producto</th>
                        <th class="p-3 text-right w-32">Precio Hoy</th>
                        <th class="p-3 text-right w-24">Precio Ayer</th>
                        <th class="p-3 text-right w-28">Var %</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">`;
    
        list.forEach(item => {
            const isDown = item.varFloat < 0;
            const vColor = isDown ? 'text-emerald-600' : (item.varFloat > 0 ? 'text-red-600' : 'text-slate-500');
            const vIcon = isDown ? 'fa-arrow-down' : (item.varFloat === 0 ? 'fa-minus' : 'fa-arrow-up');

            // Color especial para variaciones extremas
            let varCellClass = `p-3 text-right font-bold ${vColor} price-number`;
            if (Math.abs(item.varFloat) > 20) { // Variaci√≥n > 20%
                varCellClass += ' text-lg';
            }

            html += `<tr class="bg-white hover:bg-slate-50 cursor-pointer"
                    ondblclick="agregarDesdeModal(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    
            <td class="p-3 text-center font-black text-slate-400">${item.position}</td>
            <td class="p-3 font-bold text-slate-800 truncate">
                ${item.name}
                <div class="text-[10px] text-slate-500 font-semibold uppercase tracking-tighter mt-0.5">${item.market}</div>
            </td>
            <td class="p-3 text-right font-bold text-blue-800 price-number">S/${item.priceToday.toFixed(2)}</td>
            <td class="p-3 text-right price-number text-slate-500 font-medium">S/${(item.priceYesterday || 0).toFixed(2)}</td>
            <td class="${varCellClass}">
                <i class="fas ${vIcon} mr-1"></i>${item.varStr}
            </td>
    </tr>`;
});

// ESTAS 2 L√çNEAS LAS DEJAS IGUAL, NO LAS CAMBIES
html += `</tbody></table>`;
container.innerHTML = html;
}
        
        // NUEVA FUNCI√ìN: Actualizar tabla de ranking de variaci√≥n
        function updateVarRanking(order) {
            // 1. Filtrar productos v√°lidos (precio > 0, no categor√≠as, con variaci√≥n definida)
            const validProducts = database.filter(item => 
                item.priceToday > 0 && 
                !item.name.match(/^\d{2,4}\s+[A-Z]/) &&
                item.market !== '' &&
                !isNaN(item.varFloat)
            );
    
            // 2. Ordenar seg√∫n el orden solicitado
            let sorted;
            if (order === 'desc') {
                // M√°s subieron primero (variaci√≥n positiva m√°s alta)
                sorted = [...validProducts].sort((a, b) => b.varFloat - a.varFloat);
            } else {
                // M√°s bajaron primero (variaci√≥n negativa m√°s baja)
                sorted = [...validProducts].sort((a, b) => a.varFloat - b.varFloat);
            }
    
            // 3. Agregar posici√≥n (ranking)
            const rankedProducts = sorted.map((item, index) => ({
                ...item,
                position: index + 1
            }));
    
            // 4. Renderizar tabla √∫nica de variaci√≥n
            renderVarRankingTable(rankedProducts);
    }
        function openVarModal() {
            document.body.classList.add('modal-open');
            document.getElementById('varModal').style.display = 'flex';
    
            // Bot√≥n "desc" activo por defecto (m√°s subieron primero)
            document.getElementById('btnVarDesc').classList.add('bg-orange-50', 'text-orange-700');
            document.getElementById('btnVarDesc').classList.remove('text-slate-600');
            document.getElementById('btnVarAsc').classList.remove('bg-orange-50', 'text-orange-700');
            document.getElementById('btnVarAsc').classList.add('text-slate-600');
    
            // Mostrar ranking inicial (orden descendente: m√°s subieron primero)
            updateVarRanking('desc');
    }
        function closeModals() {
            document.body.classList.remove('modal-open');
            document.getElementById('priceModal').style.display = 'none';
            document.getElementById('varModal').style.display = 'none';
            setTimeout(() => searchInput.focus(), 100);
        }

        function quickSearch(val) {
            searchInput.value = val;
            const event = new Event('input', { bubbles: true });
            searchInput.dispatchEvent(event);
            searchInput.focus();
        }

        searchInput.addEventListener('input', (e) => {
            const query = normalizeStr(e.target.value);
            suggestionsBox.innerHTML = '';
            if (query.length < 2) { suggestionsBox.classList.add('hidden'); return; }
            
            const matches = database.filter(item => item.nameNormalized.includes(query)).slice(0, 10);
            
            if (matches.length > 0) {
                suggestionsBox.classList.remove('hidden');
                matches.forEach(item => {
                    const isDown = item.varFloat < 0;
                    const vColor = isDown ? 'text-emerald-600' : (item.varFloat > 0 ? 'text-red-600' : 'text-slate-500');
                    const vIcon = isDown ? 'fa-arrow-down' : (item.varFloat === 0 ? 'fa-minus' : 'fa-arrow-up');
                    const div = document.createElement('div');
                    div.className = "p-4 hover:bg-blue-50 border-b border-slate-100 flex justify-between items-center active:bg-blue-100";
                    div.innerHTML = `
                        <div class="flex-1 min-w-0 pr-2">
                            <span class="font-bold text-slate-800 block text-sm truncate">${item.name}</span>
                            <span class="text-[10px] text-slate-500 font-semibold uppercase tracking-tighter">${item.market}</span>
                        </div>
                        <div class="text-right shrink-0">
                            <div class="font-bold text-blue-800 text-sm price-number">S/ ${item.priceToday.toFixed(2)}</div>
                            <div class="text-[11px] font-semibold ${vColor} mt-0.5">
                                <i class="fas ${vIcon} mr-1"></i>${item.varStr} 
                                <span class="text-slate-400 text-[10px] font-medium">(Ayer: S/${item.priceYesterday.toFixed(2)})</span>
                            </div>
                        </div>
                    `;
                    div.onclick = () => addToCart(item);
                    suggestionsBox.appendChild(div);
                });
            } else { suggestionsBox.classList.add('hidden'); }
        });

        function addToCart(item) {
            cart.push({...item});
            updateUI();
            guardarCarrito(); // ‚Üê ESTA L√çNEA NUEVA
            searchInput.value = '';
            suggestionsBox.classList.add('hidden');
            searchInput.blur();
        }

        function clearCart() { if(confirm("¬øVaciar lista?")) { cart = []; updateUI(); localStorage.removeItem('midagriCart'); } }

        function updateUI() {
            quoteList.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                quoteList.innerHTML = `<div class="bg-white/40 border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center text-slate-400 font-bold text-xs uppercase tracking-widest leading-relaxed">Tu lista est√° vac√≠a.<br>Agrega productos para calcular.</div>`;
            } else {
                cart.forEach((item, index) => {
                    total += item.priceToday;
                    const isDown = item.varFloat < 0;
                    const vColor = isDown ? 'text-emerald-600' : (item.varFloat > 0 ? 'text-red-600' : 'text-slate-500');
                    const vIcon = isDown ? 'fa-arrow-down' : (item.varFloat === 0 ? 'fa-minus' : 'fa-arrow-up');
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center fade-in";
                    el.innerHTML = `
                        <div class="flex items-center flex-1 min-w-0 pr-2">
                            <div class="w-7 h-7 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center font-black text-[10px] mr-3 shrink-0">
                                ${index + 1}
                            </div>
                            <div class="min-w-0">
                                <h3 class="font-bold text-slate-800 text-sm truncate leading-none mb-1">${item.name}</h3>
                                <div class="flex items-center text-[10px] font-semibold uppercase tracking-tighter">
                                    <span class="text-slate-500 mr-2">${item.market}</span>
                                    <span class="${vColor} flex items-center whitespace-nowrap">
                                        <i class="fas ${vIcon} mr-1"></i>${item.varStr}
                                        <span class="text-slate-400 ml-1 text-[9px] font-medium">(Ayer: S/${item.priceYesterday.toFixed(2)})</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center shrink-0">
                            <span class="font-bold text-slate-900 mr-3 text-sm price-number">S/ ${item.priceToday.toFixed(2)}</span>
                            <button onclick="removeFromCart(${index})" class="text-slate-300 hover:text-red-500 transition-colors">
                                <i class="fas fa-times-circle text-xl"></i>
                            </button>
                        </div>
                    `;
                    quoteList.appendChild(el);
                });
            }
            totalPriceEl.innerText = `S/ ${total.toFixed(2)}`;
        }

        function removeFromCart(index) { cart.splice(index, 1); updateUI(); guardarCarrito(); }

        // 1. AGREGAR DESDE MODAL (doble click)
        function agregarDesdeModal(item) {
            addToCart(item);
            mostrarNotificacion(`‚úÖ Producto agregado: "${item.name}"`);
        }

        
        // 4. MOSTRAR NOTIFICACI√ìN
        function mostrarNotificacion(mensaje) {
            // Crear notificaci√≥n
            const notif = document.createElement('div');
            notif.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-[1000] animate-fade-in';
            notif.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span class="font-medium">${mensaje}</span>
                </div>
            `;
    
            document.body.appendChild(notif);
    
            // Quitar despu√©s de 3 segundos
            setTimeout(() => {
                notif.style.opacity = '0';
                notif.style.transition = 'opacity 0.5s';
                setTimeout(() => notif.remove(), 500);
            }, 3000);
        }
        
        function guardarCarrito() {
            // Crear objeto con todos los datos del carrito
            const datos = {
                cart: cart,  // Lista de productos
                fechaGuardado: new Date().toISOString(),  // Cu√°ndo se guard√≥
                total: cart.reduce((sum, item) => sum + item.priceToday, 0)  // Total actual
            };
    
            // Guardar en localStorage (se mantiene aunque cierre navegador)
            localStorage.setItem('midagriCart', JSON.stringify(datos));
        }

        function cargarCarritoGuardado() {
            // Intentar recuperar datos guardados
            const guardado = localStorage.getItem('midagriCart');
    
            if (guardado) {
                try {
                    const datos = JSON.parse(guardado);
                    cart = datos.cart || [];  // Restaurar carrito
                    updateUI();  // Actualizar interfaz
            
                    console.log("‚úÖ Carrito recuperado. Guardado el:", 
                               new Date(datos.fechaGuardado).toLocaleString());
                } catch (e) {
                    console.error("Error al cargar carrito guardado:", e);
                    cart = [];  // Si hay error, empezar vac√≠o
                }
            } else {
                console.log("üì≠ No hay carrito guardado anteriormente");
            }
        }
        
        function shareQuote() {
            if (cart.length === 0) return alert("¬°Lista vac√≠a!");
            let text = "*MI LISTA DE AHORRO* üõí\n";
            text += `üìÖ _${fechaReporte.innerText}_\n\n`;
            let total = 0;
            cart.forEach(item => {
                const trend = item.varFloat < 0 ? 'üìâ' : (item.varFloat > 0 ? 'üìà' : '‚ûñ');
                text += `‚Ä¢ *${item.name}*: S/${item.priceToday.toFixed(2)} ${trend} _(${item.varStr})_\n`;
                total += item.priceToday;
            });
            text += `\n*TOTAL ESTIMADO: S/${total.toFixed(2)}*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function installAppPrompt() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) {
                alert("Instala esta App: Toca el bot√≥n 'Compartir' (el cuadrado con flecha) y selecciona 'Agregar al inicio'.");
            } else {
                alert("Instala esta App: Toca los 3 puntos de Chrome y selecciona 'Instalar aplicaci√≥n' o 'Agregar a la pantalla principal'.");
            }
        }

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });
    </script>
</body>
</html>












