<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta property="og:title" content="Cotizador Mayorista - Precios Oficiales">
    <meta property="og:description" content="Consulta precios del Mercado Mayorista (MIDAGRI). ¬°No pagues de m√°s!">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Cotizador Express">

    <title>Cotizador Mayorista - Precios al D√≠a</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- GOOGLE ANALYTICS -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TU_ID_AQUI"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TU_ID_AQUI');
    </script>

    <style>
        .touch-action-manipulation { touch-action: manipulation; }
        .tap-highlight-transparent { -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        .bg-pattern { background-color: #f8fafc; background-image: radial-gradient(#cbd5e1 0.5px, transparent 0.5px); background-size: 10px 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-pattern text-slate-800 font-sans antialiased min-h-screen pb-40">

    <!-- Encabezado -->
    <header class="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div>
                <h1 class="text-xl font-black flex items-center tracking-tight">
                    <i class="fas fa-shopping-basket mr-2"></i> PRECIOS AL D√çA
                </h1>
                <p id="fechaReporte" class="text-[10px] text-blue-200 uppercase font-bold tracking-widest mt-1">Cargando...</p>
            </div>
            <div id="statusBadge" class="text-[10px] font-bold bg-blue-600 px-2 py-1 rounded-full border border-blue-400/30">
                CONECTANDO...
            </div>
        </div>
    </header>

    <main class="max-w-lg mx-auto p-4">

        <!-- Aviso de seguridad -->
        <div class="bg-amber-50 border-l-4 border-amber-400 p-3 mb-6 rounded shadow-sm flex items-start fade-in">
            <i class="fas fa-shield-alt text-amber-500 mt-0.5 mr-3"></i>
            <p class="text-xs text-amber-900 leading-snug">
                <strong>Dato de Casera:</strong> Estos son precios de referencia (por mayor). √ösalos para que no te cobren de m√°s en tu mercado local.
            </p>
        </div>

        <!-- Buscador -->
        <div class="bg-white rounded-2xl shadow-xl p-5 mb-6 border border-slate-200">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">¬øQu√© vas a comprar hoy?</label>
            <div class="relative group">
                <i class="fas fa-search absolute left-4 top-4 text-slate-300 group-focus-within:text-blue-500 transition-colors"></i>
                <input type="text" id="searchInput" 
                    placeholder="Busca papa, lim√≥n, cebolla..." 
                    inputmode="search"
                    enterkeyhint="search"
                    class="w-full pl-11 pr-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 focus:bg-white outline-none transition-all text-lg font-medium"
                    autocomplete="off" 
                    autocorrect="off"
                    spellcheck="false"
                    disabled>
                
                <div id="suggestions" class="absolute w-full bg-white shadow-2xl rounded-xl border border-slate-200 hidden max-h-[350px] overflow-y-auto z-50 mt-2"></div>
            </div>

            <!-- Accesos R√°pidos -->
            <div class="flex flex-wrap gap-2 mt-4">
                <button onclick="quickSearch('Papa')" class="px-3 py-1.5 bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 rounded-full text-xs font-bold transition-colors">ü•î Papas</button>
                <button onclick="quickSearch('Limon')" class="px-3 py-1.5 bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 rounded-full text-xs font-bold transition-colors">üçã Lim√≥n</button>
                <button onclick="quickSearch('Cebolla')" class="px-3 py-1.5 bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 rounded-full text-xs font-bold transition-colors">üßÖ Cebolla</button>
                <button onclick="quickSearch('Tomate')" class="px-3 py-1.5 bg-slate-100 hover:bg-blue-100 text-slate-600 hover:text-blue-700 rounded-full text-xs font-bold transition-colors">üçÖ Tomate</button>
            </div>
        </div>

        <!-- Lista de Cotizaci√≥n -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-sm font-black text-slate-500 uppercase tracking-widest">Tu Lista de Ahorro</h2>
            <button onclick="clearCart()" class="text-[10px] font-bold text-red-500 hover:text-red-700 uppercase tracking-tighter">
                <i class="fas fa-trash-alt mr-1"></i> Vaciar
            </button>
        </div>

        <div id="quoteList" class="space-y-3 mb-32">
            <div id="emptyState" class="bg-white/50 border-2 border-dashed border-slate-200 rounded-2xl p-10 text-center">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-shopping-cart text-slate-300 text-2xl" id="loadingIcon"></i>
                </div>
                <p id="emptyMsg" class="text-slate-400 font-medium text-sm">Busca productos arriba para agregarlos a tu lista.</p>
            </div>
        </div>

    </main>

    <!-- Footer de Total -->
    <div class="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 shadow-[0_-10px_20px_rgba(0,0,0,0.05)] p-5 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <div>
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Total Estimado</p>
                <p id="totalPrice" class="text-3xl font-black text-blue-800 tracking-tighter">S/ 0.00</p>
            </div>
            <button onclick="shareQuote()" class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-2xl font-black shadow-lg shadow-green-200 flex items-center transition-all active:scale-95">
                <i class="fab fa-whatsapp mr-2 text-xl"></i> PEDIR
            </button>
        </div>
    </div>

    <script>
        const CSV_URL = 'data/precios_mercado.csv'; 
        let database = [];
        let cart = [];
        let colPrecioHoy = -1;
        let colVarHoy = -1;

        const searchInput = document.getElementById('searchInput');
        const suggestionsBox = document.getElementById('suggestions');
        const quoteList = document.getElementById('quoteList');
        const emptyState = document.getElementById('emptyState');
        const totalPriceEl = document.getElementById('totalPrice');
        const statusBadge = document.getElementById('statusBadge');
        const fechaReporte = document.getElementById('fechaReporte');

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                procesarCSV(csvText);
                
                statusBadge.innerText = "SISTEMA ACTIVO";
                statusBadge.className = "text-[10px] font-bold bg-green-500 px-2 py-1 rounded-full text-white fade-in";
                searchInput.disabled = false;
            } catch (error) {
                statusBadge.innerText = "ERROR DE CARGA";
                statusBadge.className = "text-[10px] font-bold bg-red-500 px-2 py-1 rounded-full text-white";
                document.getElementById('emptyMsg').innerText = "No se pudo conectar con los precios de hoy.";
            }
        });

        function procesarCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            
            // Columna de hoy (pen√∫ltima) y Variaci√≥n Hoy/Ayer (√∫ltima)
            colPrecioHoy = headers.length - 2;
            colVarHoy = headers.length - 1;
            fechaReporte.innerText = `Referencia: ${headers[colPrecioHoy]}`;

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < headers.length) continue;

                const precio = parseFloat(row[colPrecioHoy]);
                if (!isNaN(precio)) {
                    database.push({
                        name: row[1].replace(/"/g, ''),
                        market: row[2].replace(/"/g, ''),
                        price: precio,
                        variation: row[colVarHoy] ? row[colVarHoy].replace(/"/g, '') : "0%"
                    });
                }
            }
        }

        function quickSearch(val) {
            searchInput.value = val;
            searchInput.dispatchEvent(new Event('input'));
            searchInput.focus();
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            suggestionsBox.innerHTML = '';
            if (query.length < 2) { suggestionsBox.classList.add('hidden'); return; }

            const matches = database.filter(item => item.name.toLowerCase().includes(query)).slice(0, 10);
            
            if (matches.length > 0) {
                suggestionsBox.classList.remove('hidden');
                matches.forEach(item => {
                    const isDown = item.variation.includes('-');
                    const varColor = isDown ? 'text-green-500' : (item.variation === '0.0%' || item.variation === '0%' ? 'text-slate-400' : 'text-red-500');
                    const varIcon = isDown ? 'fa-arrow-down' : (item.variation === '0.0%' || item.variation === '0%' ? 'fa-minus' : 'fa-arrow-up');

                    const div = document.createElement('div');
                    div.className = "p-4 hover:bg-blue-50 cursor-pointer border-b border-slate-100 flex justify-between items-center active:bg-blue-100 transition-colors";
                    div.innerHTML = `
                        <div class="flex-1">
                            <span class="font-bold text-slate-700 block text-sm">${item.name}</span>
                            <span class="text-[10px] text-slate-400 font-bold uppercase">${item.market}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-black text-blue-600">S/ ${item.price.toFixed(2)}</div>
                            <div class="text-[9px] font-black ${varColor} flex items-center justify-end">
                                <i class="fas ${varIcon} mr-1"></i> ${item.variation}
                            </div>
                        </div>
                    `;
                    div.onclick = () => addToCart(item);
                    suggestionsBox.appendChild(div);
                });
            } else {
                suggestionsBox.classList.add('hidden');
            }
        });

        function addToCart(item) {
            cart.push({...item});
            updateUI();
            searchInput.value = '';
            suggestionsBox.classList.add('hidden');
            searchInput.blur();
        }

        function clearCart() {
            if(confirm("¬øVaciar toda tu lista?")) {
                cart = [];
                updateUI();
            }
        }

        function updateUI() {
            quoteList.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                quoteList.appendChild(emptyState);
            } else {
                cart.forEach((item, index) => {
                    total += item.price;
                    const el = document.createElement('div');
                    el.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center fade-in";
                    el.innerHTML = `
                        <div class="flex items-center flex-1">
                            <div class="w-8 h-8 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center font-black text-xs mr-3">
                                ${index + 1}
                            </div>
                            <div class="pr-2">
                                <h3 class="font-bold text-slate-700 text-sm leading-none mb-1">${item.name}</h3>
                                <p class="text-[10px] text-slate-400 font-bold uppercase">${item.market}</p>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="font-black text-slate-800 mr-4">S/ ${item.price.toFixed(2)}</span>
                            <button onclick="removeFromCart(${index})" class="text-slate-300 hover:text-red-500 p-2 transition-colors">
                                <i class="fas fa-times-circle text-xl"></i>
                            </button>
                        </div>
                    `;
                    quoteList.appendChild(el);
                });
            }
            totalPriceEl.innerText = `S/ ${total.toFixed(2)}`;
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateUI();
        }

        function shareQuote() {
            if (cart.length === 0) return alert("¬°Agrega algo a tu lista primero!");
            let text = "*MI LISTA DE AHORRO* üõí\n";
            text += `üìÖ _${fechaReporte.innerText}_\n\n`;
            let total = 0;
            cart.forEach(item => {
                text += `‚Ä¢ *${item.name}*: S/ ${item.price.toFixed(2)}\n`;
                total += item.price;
            });
            text += `\n*TOTAL ESTIMADO: S/ ${total.toFixed(2)}*`;
            text += `\n\nüîç Revisa t√∫ tambi√©n aqu√≠: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
                suggestionsBox.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
